<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PubMed Scraper Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 2rem; }
        pre { white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body class="container py-5">
    <h1 class="mb-4 text-center">Scraper Control Panel</h1>
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h5>Scraper Control</h5></div>
                <div class="card-body">
                    <p>Start the iterative scraping process to find papers on PubMed.</p>
                    <form action="/scrape" method="post">
                        <button type="submit" class="btn btn-primary w-100" {% if scrape_status.status == 'running' %}disabled{% endif %}>
                            {% if scrape_status.status == 'running' %}<span class="spinner-border spinner-border-sm"></span> Running...{% else %}Start Scraping{% endif %}
                        </button>
                    </form>
                </div>
                <div class="card-footer">
                    <strong>Status:</strong> <span id="scrape-status-text" class="badge bg-info">{{ scrape_status.status }}</span><br>
                    <strong>Last Result:</strong> <pre id="scrape-result-text" class="mb-0 small bg-light p-2 mt-1 rounded">{{ scrape_status.last_result | tojson(indent=2) if scrape_status.last_result else 'N/A' }}</pre>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><h5>Database Sync</h5></div>
                <div class="card-body">
                    <p>Transfer all data from the cloud (Atlas) database to your local database.</p>
                    <form action="/transfer-data" method="post">
                        <button type="submit" class="btn btn-secondary w-100" {% if transfer_status.status == 'running' %}disabled{% endif %}>
                             {% if transfer_status.status == 'running' %}<span class="spinner-border spinner-border-sm"></span> Transferring...{% else %}Sync to Local DB{% endif %}
                        </button>
                    </form>
                </div>
                <div class="card-footer">
                    <strong>Status:</strong> <span id="transfer-status-text" class="badge bg-info">{{ transfer_status.status }}</span><br>
                    <strong>Last Result:</strong> <pre id="transfer-result-text" class="mb-0 small bg-light p-2 mt-1 rounded">{{ transfer_status.last_result | tojson(indent=2) if transfer_status.last_result else 'N/A' }}</pre>
                </div>
            </div>
        </div>
    </div>
    <script>
        const scrapeStatusText = document.getElementById('scrape-status-text');
        const scrapeResultText = document.getElementById('scrape-result-text');
        const transferStatusText = document.getElementById('transfer-status-text');
        const transferResultText = document.getElementById('transfer-result-text');
        async function updateStatus() {
            const response = await fetch('/status');
            const data = await response.json();
            const currentScrapeStatus = scrapeStatusText.textContent;
            const currentTransferStatus = transferStatusText.textContent;
            scrapeStatusText.textContent = data.scraper.status;
            scrapeResultText.textContent = data.scraper.last_result ? JSON.stringify(data.scraper.last_result, null, 2) : 'N/A';
            transferStatusText.textContent = data.transfer.status;
            transferResultText.textContent = data.transfer.last_result ? JSON.stringify(data.transfer.last_result, null, 2) : 'N/A';
            if ((currentScrapeStatus === 'running' && data.scraper.status !== 'running') || 
                (currentTransferStatus === 'running' && data.transfer.status !== 'running')) {
                window.location.reload();
            }
        }
        if ('{{ scrape_status.status }}' === 'running' || '{{ transfer_status.status }}' === 'running') {
            setInterval(updateStatus, 5000);
        }
    </script>
</body>
</html>